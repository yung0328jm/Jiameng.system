# 下一步：即時同步與部署

目前程式已完成「全站同步＋Realtime 即時更新」，照下面步驟做完即可在多人環境使用。

---

## 一、在 Supabase 建立／更新資料表

1. 登入 Supabase，選專案 **Jiameng.system**。
2. 左側點 **SQL Editor** → **New query**。
3. 開啟專案裡的 **`docs/supabase-schema.sql`**，把整份內容複製貼到 SQL Editor。
4. 按 **Run** 執行。

這會建立／確保有這些表與權限：

- `engineering_schedules`、`leave_applications`、`special_leave_quota`（排程、請假、特休）
- `app_data`（其餘所有功能：待辦、使用者、交易所、交流區、行事曆……）
- 各表的 RLS 與 anon 讀寫 policy
- **Realtime**：`alter publication supabase_realtime add table ...` 那四行

若執行時出現「relation … is already in publication」之類錯誤，表示該表已在 Realtime 裡，可略過那幾行或只執行失敗的那幾張表以外的部分。

---

## 二、確認環境變數（本機與 Vercel）

- **本機**：專案根目錄的 `.env` 要有  
  `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`  
  （到 Supabase **Project Settings → API** 複製 Project URL 與 anon public key。）

- **Vercel**：該專案的 **Settings → Environment Variables** 也要有同樣兩個變數，存好後到 **Deployments** 對最新部署按 **Redeploy**。

---

## 三、已具備的即時同步機制

- **登入時**：會先跑一次 `syncFromSupabase()`，把雲端資料拉進本機 localStorage。
- **寫入時**：各功能（排程、請假、待辦、使用者、交易所、交流區……）在寫入 localStorage 的同時，會透過 `syncKeyToSupabase()` 寫進 Supabase。
- **Realtime**：`SyncProvider` 會訂閱 Supabase 的 `postgres_changes`（`engineering_schedules`、`leave_applications`、`special_leave_quota`、`app_data`）。  
  任一裝置改動資料 → Supabase 觸發 Realtime → 其它已開啟的瀏覽器會更新 localStorage 並觸發 `supabase-realtime-update` 事件，畫面會即時重讀資料。

頁面若需在「別人改動」時自動刷新，可掛 `useRealtimeKeys()` 或監聽 `REALTIME_UPDATE_EVENT`（見 `src/contexts/SyncContext.jsx`）。

---

## 四、部署與驗證

1. 將專案 push 到 GitHub（若尚未）。
2. 在 Vercel 從該 repo **Import**，Framework 選 **Vite**，建好專案並確認有設好 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY` 後 Deploy／Redeploy。
3. 用手機與電腦各開部署好的網址，登入同一或不同帳號，在任一端新增／修改（例如待辦、排程、請假、交流區、交易所），另一端應在幾秒內看到更新，無需登出再登入。

---

## 五、若多裝置即時同步沒反應時

1. **看 Console 連線狀態**  
   在兩臺裝置都打開部署好的網址並登入後，用電腦開「開發者工具 → Console」。  
   - **開發模式**：若連線正常會看到 `[Realtime] app_data 已連線`、`[Realtime] engineering_schedules 已連線` 等。  
   - **部署後**：Console 不會顯示「已連線」；但若有訂閱失敗，會出現 `[Realtime] app_data CHANNEL_ERROR` 或 `TIMED_OUT`。  
   若出現 `[Realtime] app_data CHANNEL_ERROR`，多半是 **app_data 未加入 Realtime publication**，請照下面第 2 點處理。

2. **確認 Supabase Realtime 有開**  
   到 Supabase **Database → Replication**（或對應設定），確認 `engineering_schedules`、`leave_applications`、`special_leave_quota`、`app_data` 都在 **Supabase Realtime** 的 publication 內。  
   若之前執行 schema 時略過了「already in publication」那幾行，這些表應該已在内；若沒跑過，請執行 `docs/supabase-schema.sql` 最後那四行 `alter publication ... add table ...`。

3. **確認環境變數**  
   - Vercel：**Settings → Environment Variables** 要有 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`（與本機相同），存檔後 **Redeploy**。  
   - 手機、電腦都要開「同一個部署網址」（不要一臺開 localhost、一臺開 Vercel，否則至少要兩邊都設好 Supabase 才可能同步）。

4. **確認兩端都已登入**  
   即時同步在「登入後、sync 完成」才會訂閱；若一臺沒登入或卡在「正在同步…」，那一臺不會收到 Realtime。

---

## 六、若「只有工程排程同步、待辦／使用者／交易所等都沒有」

這多半是 **`app_data` 這張表沒有加入 Realtime publication**。工程排程用 `engineering_schedules` 表，其它功能用 `app_data` 表；若只有排程會即時同步，代表 `app_data` 的 Realtime 沒開。

**請依序做：**

1. 到 Supabase **SQL Editor**，**只執行**下面這一行（不要整份 schema 重跑）：
   ```sql
   alter publication supabase_realtime add table public.app_data;
   ```
   若出現「relation … is already in publication」，表示已加入，可略過。

2. 到 Supabase **Database → Replication**（或 **Database → Publications**），確認 **supabase_realtime** 底下有這四張表：
   - `engineering_schedules`
   - `leave_applications`
   - `special_leave_quota`
   - **`app_data`**（若只有前三張、沒有 app_data，其它功能就不會即時同步）

3. 確認後，兩臺裝置都**重新整理**部署網址並登入，再測一次待辦／交易所／使用者等是否會即時更新。

---

## 七、若「完全沒有同步資料」

請先判斷是「沒連到雲端」還是「有連但沒拿到資料／多裝置沒即時」：

1. **看 Console 的 [Sync] 訊息**  
   打開**部署好的網址**（不要開 localhost），登入後按 F12 → **Console**，看有沒有這幾種其中一種：
   - **`[Sync] 未設定 Supabase，僅使用本機資料`**  
     → 代表 **Vercel 沒有設環境變數**。請到 Vercel 專案 **Settings → Environment Variables** 新增 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`（值與本機 .env 相同），存檔後到 **Deployments** 按 **Redeploy**。
   - **`[Sync] 已從雲端載入 { 排程: N, 請假: M, app_data: K }`**  
     → 代表有連到 Supabase 且登入時有從雲端拉資料。若多裝置仍沒即時更新，請照「五、若多裝置即時同步沒反應時」與「六」檢查 Realtime 與 app_data publication。
   - **`[Sync] 從雲端載入失敗`** ＋ 錯誤內容  
     → 代表有連到 Supabase 但請求失敗（可能是網路、RLS、或表尚未建立）。請到 Supabase 執行 `docs/supabase-schema.sql`，並確認 **Project Settings → API** 的 URL 與 anon key 與 Vercel 環境變數一致。

2. **確認本機 .env**  
   本機專案根目錄要有 `.env`，內容包含 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`。  
   若本機有設、部署沒有，部署網址就會出現「未設定 Supabase」。

3. **確認兩端都在同一個網址**  
   測試多裝置時，手機與電腦都要開**同一個部署網址**（例如 `https://jiameng-system.vercel.app`），不要一臺開 localhost、一臺開 Vercel。

以上都做完，整個 App 就會是「多人、即時同步」的狀態。

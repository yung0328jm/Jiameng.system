# 帳號管理（Supabase Auth + profiles）— 設定步驟

照下面順序做，就能讓系統用 **Supabase Auth** 登入／登出，用戶資料存在 **profiles** 表，並支援「帳號或 Email」登入與管理員權限。

---

## 步驟一：確認 Supabase 專案與環境變數

1. 登入 [Supabase](https://supabase.com) → 選你的專案（或新建一個）。
2. 左側 **Project Settings** → **API**，記下：
   - **Project URL**
   - **anon public**（Project API keys）
3. 在專案根目錄的 `.env` 裡設定（若已有可略過）：
   ```env
   VITE_SUPABASE_URL=你的 Project URL
   VITE_SUPABASE_ANON_KEY=你的 anon public key
   ```
4. 重啟本地開發伺服器（`npm run dev`）讓變數生效。

---

## 步驟二：在 Supabase 建立 profiles 表與權限

1. 在 Supabase 左側點 **SQL Editor**。
2. 新增一個 Query，把下面整段 **複製貼上**，然後按 **Run**。

```sql
-- profiles：帳號、顯示名稱、是否管理員；id 對應 auth.users
create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  account text unique not null,
  display_name text,
  is_admin boolean default false,
  email text not null
);

-- 供「用 account 登入」時查詢對應 email（僅回傳 email）
create or replace function public.get_email_by_account(acc text)
returns text
language sql
security definer
set search_path = public
as $$
  select email from profiles where account = acc limit 1;
$$;

-- 僅允許已登入用戶讀取／更新自己的 profile
alter table public.profiles enable row level security;

create policy "Users can read own profile"
  on public.profiles for select
  using (auth.uid() = id);

create policy "Users can update own profile"
  on public.profiles for update
  using (auth.uid() = id);

-- 註冊時允許插入自己的 profile（id = auth.uid()）
create policy "Users can insert own profile"
  on public.profiles for insert
  with check (auth.uid() = id);

-- 允許 anon 呼叫 get_email_by_account（登入時查 email 用）
grant execute on function public.get_email_by_account(text) to anon;
grant execute on function public.get_email_by_account(text) to authenticated;
```

3. 確認沒有錯誤訊息；若有，多半是權限或已存在物件，可依錯誤內容調整（例如表已存在就略過 `create table`）。

---

## 步驟三：（可選）關閉「註冊須驗證 Email」

若希望註冊後 **不用收信、直接登入**：

1. Supabase 左側 **Authentication** → **Providers** → **Email**。
2. 把 **Confirm email** 關閉（Disable）。
3. 儲存。

若保持開啟，用戶註冊後需到信箱點確認連結才能登入。

---

## 步驟四：設定第一個管理員

系統的「管理員」是看 **profiles 表** 的 `is_admin`，要在資料庫手動設。

**做法 A：先註冊一個帳號再設成管理員**

1. 在網站上用 **註冊** 頁註冊一個帳號（例如帳號 `admin`）。
2. 到 Supabase **SQL Editor** 執行：
   ```sql
   update public.profiles set is_admin = true where account = 'admin';
   ```
   （把 `'admin'` 改成你註冊時用的 **帳號**）

**做法 B：已有用戶，直接指定帳號為管理員**

1. 到 Supabase **Table Editor** → **profiles**，確認該用戶的 `account` 欄位。
2. 在 **SQL Editor** 執行：
   ```sql
   update public.profiles set is_admin = true where account = '你要的帳號';
   ```

設好後，用該帳號登入即可進入「用戶管理」、「下拉選單管理」等管理員頁面。

---

## 步驟五：驗證流程

1. **註冊**  
   - 打開 `/register`，填姓名、帳號、註冊密碼（若系統有開）、密碼。  
   - 送出後應顯示「註冊成功！用戶資料已儲存」並跳轉到 dashboard。

2. **登入**  
   - 用剛註冊的 **帳號** 或 **Email**（目前為 `帳號@jiameng.local`）＋密碼登入。  
   - 應能進入首頁，重整後仍保持登入。

3. **管理員**  
   - 用已設為 `is_admin = true` 的帳號登入。  
   - 應能進入「用戶管理」、「下拉選單管理」；一般用戶進入會被導向 dashboard。

4. **登出**  
   - 點登出後應回到登入頁，再重整也不會自動登入。

---

## 對照：邏輯與步驟的關係

| 項目 | 對應步驟 |
|------|----------|
| Supabase Auth 管理登入／登出／session | 步驟一（設好 URL、Key 後，程式已接好） |
| 用戶資料存 profiles（account、display_name、is_admin） | 步驟二（建表 + RLS） |
| 可用 **email** 或 **account** 登入 | 步驟二（`get_email_by_account`） |
| 要登入才能進的頁面 | 程式已用 session 判斷 |
| 要管理員才能進的頁面（ProtectedRoute） | 步驟四（設 `profiles.is_admin`） |
| 管理員在資料庫手動設定 | 步驟四 |

---

## 常見問題

- **註冊失敗：建立用戶資料失敗**  
  多半是步驟二沒做或 RLS 阻擋。請確認 `profiles` 表與三條 policy 都已建立，且「Users can insert own profile」的 `with check (auth.uid() = id)` 存在。

- **登入時說帳號或密碼錯誤**  
  確認該用戶在 **Authentication → Users** 存在，且 **Table Editor → profiles** 裡有對應一筆（同一個 `id`），且 `email` 與 Auth 用的 email 一致。

- **重整後變未登入**  
  確認 `.env` 的 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY` 正確，且沒有在無痕模式或阻擋 cookie／localStorage 的環境。

- **一般用戶也能進管理頁**  
  檢查該使用者在 `profiles` 的 `is_admin` 是否為 `true`；只有 `true` 才會被當成管理員。

完成以上步驟後，帳號管理邏輯就會依設計運作，用戶資料會正確寫入 **profiles** 並在登入／重整時同步。
